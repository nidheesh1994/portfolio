<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Futuristic Website</title>
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>



    <!-- ─── Gradio JS client + chat logic ─────────────────────────── -->
    <script type="module">
      import { client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

      let chatbot;
      let chatHistory = []; // 💡 store the conversation history globally

      async function initChatbot() {
        chatbot = await client("nidheesh1994/ai-assistant", {
          events: ["data", "status"],
        });
        console.log("🤖 Chatbot loaded");
      }

      window.addEventListener("DOMContentLoaded", initChatbot);

      window.sendMessageToBot = async function (userMessage) {
        const chatWin = document.getElementById("chat-window");
        const chatStat = document.getElementById("chat-status");

        // Show user message
        const msgDiv = document.createElement("div");
        msgDiv.className = "msg me";
        msgDiv.textContent = userMessage;
        chatWin.appendChild(msgDiv);
        chatWin.scrollTop = chatWin.scrollHeight;

        const systemPrompt = `You are Prometheous, the personal AI assistant of Nidheesh Jagadeesan. 
You only speak about him and answer in detail when users ask about Nidheesh's background, skills or projects.`;

        chatStat.textContent = "Prometheous is thinking…";

        // 🧠 Send updated chat history
        const submission = chatbot.submit("/chat", [
          userMessage,
          chatHistory, // ← Pass the history
          systemPrompt,
        ]);

        for await (const msg of submission) {
          if (msg.type === "data") {
            const reply = msg.data[0];

            // Show bot reply
            const botDiv = document.createElement("div");
            botDiv.className = "msg bot";
            botDiv.innerHTML = marked.parse(DOMPurify.sanitize(reply));
            chatWin.appendChild(botDiv);
            chatWin.scrollTop = chatWin.scrollHeight;

            chatStat.textContent = "";

            // 📌 Save the exchange
            chatHistory.push([userMessage, reply]);
          }

          if (msg.type === "status") {
            console.log("Status:", msg);
          }
        }
      };

      window.addEventListener("DOMContentLoaded", () => {
        const btn = document.getElementById("chat-send");
        const input = document.getElementById("chat-input");

        btn.addEventListener("click", () => {
          const val = input.value.trim();
          if (val) {
            window.sendMessageToBot(val);
            input.value = "";
          }
        });

        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") btn.click();
        });
      });
    </script>
  </head>

  <body>
    <!-- Loading overlay & 3-D canvas remain unchanged -->
    <div id="loading-container"><div id="loading-text">Loading</div></div>
    <canvas id="bg-canvas"></canvas>

    <section id="main-section">
      <h1>Welcome to the Future</h1>
      <button id="begin-button">Let’s Begin</button>
    </section>

    <!-- Chat section -->
    <section id="next-section">
      <h2>I am Prometheous – An AI Assistant of Nidheesh</h2>
      <h4>You can ask about him</h4>
      <div id="chat-window"></div>
      <div id="chat-controls">
        <input id="chat-input" placeholder="Ask me anything about Nidheesh…" />
        <button id="chat-send">Send</button>
      </div>
      <p id="chat-status" style="opacity: 0.7; font-size: 0.9rem"></p>
    </section>

    <script src="https://cdn.jsdelivr.net/npm/three-js@79.0.0/three.min.js"></script>
    <script src="script.js"></script>
  </body>
</html>
